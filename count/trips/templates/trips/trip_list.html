{% extends "base.html" %}
{% load static %}
{% load form_tags %}
{% load widget_tweaks %}
{% block title %}Viajes Dashboard{% endblock %}
{% block content %}

<div class="row">
  <!-- Sidebar filtros -->
  <div class="col-md-3">
    <form method="get" class="p-3 border rounded bg-light">
      <h6 class="fw-bold">Buscar</h6>
      <input type="text" name="q" class="form-control mb-2" value="{{ request.GET.q }}" placeholder="Cliente, chofer...">

      <h6 class="fw-bold mt-3">Estado</h6>
      {% for estado, label in trips.model.STATUS_CHOICES %}
        <div class="form-check">
          <input type="checkbox" name="status" value="{{ estado }}" id="status{{ forloop.counter }}"
                 class="form-check-input"
                 {% if estado in request.GET.status %}checked{% endif %}>
          <label class="form-check-label" for="status{{ forloop.counter }}">{{ label }}</label>
        </div>
      {% endfor %}

      <div class="d-grid gap-2 mt-4">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-funnel-fill me-1"></i> Filtrar
        </button>
        <a href="{% url 'trip_create' %}" class="btn btn-success">
          <i class="bi bi-plus-circle me-1"></i> Nuevo viaje
        </a>
      </div>
    </form>
  </div>

  <!-- Lista de viajes -->
  <div class="col-md-9">
    {% for t in trips %}
<!-- Card de viaje -->
<div class="card mb-3 shadow-sm" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#tripModal{{ t.id }}">
  <div class="card-body d-flex justify-content-between align-items-center">
    <div>
      <h5 class="mb-1">Nro{{ t.id|stringformat:"05d" }}</h5>
      <span class="badge 
        {% if t.status == 'recibido' %}bg-success
        {% elif t.status == 'pendiente' %}bg-warning text-dark
        {% elif t.status == 'no_completado' %}bg-danger
        {% elif t.status == 'facturado' %}bg-primary
        {% else %}bg-secondary{% endif %}">
        {{ t.get_status_display }}
      </span>
      <p class="text-muted mb-0 small">{{ t.client }} – {{ t.end_address }}</p>
    </div>
    <div>
      {% if t.status == 'pendiente' %}
        <!-- Botón que abre el modal -->
        <button type="button"
                class="btn btn-sm btn-dark"
                data-bs-toggle="modal"
                data-bs-target="#confirmModal{{ t.id }}"
                onclick="event.stopPropagation();">
          Ingresar
        </button>
      {% elif t.status == 'recibido' %}
        {% if t.first_invoice %}
          <a class="btn btn-sm btn-outline-success" href="{% url 'trips:invoice_detail' t.first_invoice.id %}" onclick="event.stopPropagation();">Factura</a>
        {% else %}
          <span class="text-muted">Sin factura</span>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal de confirmación para Ingresar -->
{% if t.id %}
<div class="modal fade" id="confirmModal{{ t.id }}" tabindex="-1" aria-labelledby="confirmModalLabel{{ t.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel{{ t.id }}">Confirmar ingreso</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Confirmás que el viaje <strong>#{{ t.id }}</strong> ha llegado y debe marcarse como <strong>recibido</strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a href="{% url 'trips:trip_complete' t.id %}" class="btn btn-primary">Sí, confirmar</a>
      </div>
    </div>
  </div>
</div>
{% endif %}
    {% endfor %}
    <!--modal aceptar viaje-->
    {% if t.id %}
    <div class="modal fade" id="confirmModal{{ t.id }}" tabindex="-1" aria-labelledby="confirmModalLabel{{ t.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmModalLabel{{ t.id }}">Confirmar llegada del viaje</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
              <div class="modal-body">
                ¿Confirmás que el viaje <strong>#{{ t.id }}</strong> fue recibido correctamente?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="{% url 'trips:trip_complete' t.id %}" class="btn btn-primary">Confirmar llegada</a>
              </div>
            </div>
        </div>
      </div>
      {% endif %}

    <!-- Paginación -->
{% if is_paginated %}
<nav aria-label="Paginación de facturas">
  <ul class="pagination justify-content-center mt-4">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.orden %}orden={{ request.GET.orden }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Anterior">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">&laquo;</span>
      </li>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item"><a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.orden %}orden={{ request.GET.orden }}&{% endif %}page={{ num }}">{{ num }}</a></li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.orden %}orden={{ request.GET.orden }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Siguiente">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">&raquo;</span>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}
  </div>
</div>


{% endblock %}
